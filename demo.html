<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apex Risk AI - 现代生产力工作台</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            color: #334155;
        }

        /* 深度投影与清晰边界 */
        .glass-card {
            background: white;
            border: 1px solid #e2e8f0;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.04), 0 4px 6px -4px rgba(0, 0, 0, 0.04);
            border-radius: 12px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* 侧边栏折叠动画 */
        .sidebar-anim {
            transition: all 0.3s ease;
        }

        .is-collapsed-left {
            width: 0 !important;
            opacity: 0;
            margin-right: 0 !important;
            pointer-events: none;
            transform: translateX(-20px);
        }

        .is-collapsed-right {
            width: 0 !important;
            opacity: 0;
            margin-left: 0 !important;
            pointer-events: none;
            transform: translateX(20px);
        }

        .is-collapsed-bottom {
            height: 0 !important;
            opacity: 0;
            margin: 0 !important;
            pointer-events: none;
            transform: translateY(20px);
        }

        /* 高对比度输入框 */
        .command-bar-highlight {
            border: 2px solid #94a3b8;
            /* 强对比边框 */
            background: #ffffff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transition: all 0.2s;
        }

        .command-bar-highlight:focus-within {
            border-color: #2563eb;
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.15);
        }

        /* 极致紧凑 Tab */
        .micro-tab {
            height: 32px;
            font-size: 11px;
            font-weight: 700;
            padding: 0 12px;
            border-radius: 6px;
            color: #64748b;
            transition: all 0.2s;
        }

        .micro-tab.active {
            background: #2563eb;
            color: white;
            box-shadow: 0 4px 8px rgba(37, 99, 235, 0.25);
        }

        /* 手风琴抽屉样式 */
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .accordion-content.open {
            max-height: 400px;
            padding-bottom: 12px;
        }

        .rotate-icon {
            transition: transform 0.2s;
        }

        .rotate-icon.open {
            transform: rotate(90deg);
        }

        /* 唤醒手柄 */
        .wake-handle {
            position: absolute;
            z-index: 50;
            background: #fff;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            display: none;
            cursor: pointer;
            align-items: center;
            justify-content: center;
            color: #2563eb;
            border-radius: 50%;
        }
    </style>
</head>

<body class="h-screen w-screen flex flex-col overflow-hidden">

    <header
        class="h-14 bg-white/90 backdrop-blur border-b border-slate-200 flex items-center justify-between px-6 z-50 shadow-sm">
        <div class="flex items-center space-x-4">
            <div class="flex items-center space-x-2">
                <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white shadow-lg">
                    <i class="fas fa-shield-halved"></i>
                </div>
                <span class="text-slate-900 font-bold text-lg tracking-tight">ApexRisk AI</span>
            </div>
            <div class="h-6 w-[1px] bg-slate-200 mx-2"></div>
            <nav class="flex p-1 bg-slate-100 rounded-lg space-x-1">
                <button onclick="switchTab('visual')" id="tab-visual" class="micro-tab active">分析看板</button>
                <button onclick="switchTab('data')" id="tab-data" class="micro-tab">数据预览</button>
                <button onclick="switchTab('sql')" id="tab-sql" class="micro-tab">SQL 实验室</button>
                <button onclick="switchTab('model')" id="tab-model" class="micro-tab">模型中心</button>
            </nav>
        </div>
        <div class="flex items-center space-x-3">
            <button onclick="resetAll()"
                class="text-[10px] font-bold text-slate-400 hover:text-blue-600 uppercase">Reset Layout</button>
            <div
                class="w-8 h-8 rounded-full border border-slate-200 bg-blue-600 flex items-center justify-center text-white text-[10px] font-bold">
                RA</div>
        </div>
    </header>

    <div class="flex-1 flex overflow-hidden p-4 gap-4 bg-slate-50 relative">

        <div id="h-left" onclick="toggle('left')" class="wake-handle w-8 h-8 left-2 top-1/2 -translate-y-1/2"><i
                class="fas fa-database"></i></div>
        <div id="h-right" onclick="toggle('right')" class="wake-handle w-8 h-8 right-2 top-1/2 -translate-y-1/2"><i
                class="fas fa-bolt"></i></div>
        <div id="h-bottom" onclick="toggle('bottom')" class="wake-handle w-10 h-6 bottom-4 left-1/2 -translate-x-1/2"><i
                class="fas fa-chevron-up"></i></div>

        <aside id="side-left" class="sidebar-anim w-64 flex-none flex flex-col gap-4">
            <div class="glass-card flex-1 flex flex-col overflow-hidden">
                <div class="p-3 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                    <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Explorer</span>
                    <button onclick="toggle('left')" class="text-slate-300 hover:text-blue-600"><i
                            class="fas fa-indent"></i></button>
                </div>

                <div class="flex-1 overflow-y-auto p-2 space-y-1">
                    <div class="border-b border-slate-50 last:border-0">
                        <div onclick="toggleAccordion('acc-db', 'arr-db')"
                            class="flex items-center justify-between p-2 hover:bg-slate-50 rounded-lg cursor-pointer">
                            <div class="flex items-center text-xs font-bold text-slate-600">
                                <i id="arr-db" class="fas fa-chevron-right text-[9px] mr-2 rotate-icon"></i>
                                <i class="fas fa-server mr-2 text-blue-500"></i> DATABASE
                            </div>
                            <div class="flex space-x-2 text-slate-300">
                                <i class="fas fa-plus hover:text-blue-600" title="添加连接"></i>
                                <i class="fas fa-gear hover:text-slate-600" title="管理"></i>
                            </div>
                        </div>
                        <div id="acc-db" class="accordion-content px-2 space-y-1">
                            <div class="p-2 bg-blue-50/50 border border-blue-100 rounded-lg cursor-pointer">
                                <div class="text-[11px] font-bold text-blue-700 flex justify-between">
                                    <span><i class="fas fa-table mr-1"></i> loan_data_v2</span>
                                    <i class="fas fa-check-circle text-green-500"></i>
                                </div>
                                <div class="text-[9px] text-blue-400 mt-1 uppercase">Hive Production</div>
                            </div>
                        </div>
                    </div>

                    <div class="border-b border-slate-50 last:border-0">
                        <div onclick="toggleAccordion('acc-schema', 'arr-schema')"
                            class="flex items-center justify-between p-2 hover:bg-slate-50 rounded-lg cursor-pointer">
                            <div class="flex items-center text-xs font-bold text-slate-600">
                                <i id="arr-schema" class="fas fa-chevron-right text-[9px] mr-2 rotate-icon"></i>
                                <i class="fas fa-list-check mr-2 text-purple-500"></i> SCHEMA PREVIEW
                            </div>
                        </div>
                        <div id="acc-schema" class="accordion-content px-3 space-y-2 text-[11px]">
                            <div class="flex justify-between border-b border-slate-50 pb-1">
                                <span class="text-slate-500 font-medium">user_id</span><span
                                    class="text-[9px] bg-blue-100 text-blue-600 px-1 rounded">PK</span>
                            </div>
                            <div class="flex justify-between border-b border-slate-50 pb-1">
                                <span class="text-slate-500 font-medium">annual_inc</span><span
                                    class="text-[9px] text-red-500 font-bold">M: 15%</span>
                            </div>
                        </div>
                    </div>

                    <div>
                        <div onclick="toggleAccordion('acc-hist', 'arr-hist')"
                            class="flex items-center justify-between p-2 hover:bg-slate-50 rounded-lg cursor-pointer">
                            <div class="flex items-center text-xs font-bold text-slate-600">
                                <i id="arr-hist" class="fas fa-chevron-right text-[9px] mr-2 rotate-icon"></i>
                                <i class="fas fa-history mr-2 text-orange-400"></i> HISTORY
                            </div>
                        </div>
                        <div id="acc-hist" class="accordion-content px-3 text-[10px] text-slate-400 italic py-1">
                            Last session: WOE Analysis 10:42 AM...
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <main class="flex-1 flex flex-col gap-4 min-w-0">
            <section class="flex-1 glass-card flex flex-col overflow-hidden relative">
                <div class="flex-1 relative bg-white">
                    <div id="view-visual" class="tab-view h-full flex flex-col p-6">
                        <div class="flex justify-between items-center w-full mb-4">
                            <h2 id="analysis-title" class="text-sm font-bold text-slate-700 flex items-center">
                                <span class="w-2 h-2 bg-blue-500 rounded-full mr-2"></span> 特征分箱趋势: annual_inc
                            </h2>
                            <div id="analysis-badges" class="flex items-center gap-2">
                                <span class="text-[10px] font-bold px-2 py-0.5 bg-red-100 text-red-600 rounded-full">单调性异常警告</span>
                            </div>
                        </div>
                        <div id="analysis-output" class="flex-1 min-h-0 flex flex-col gap-4">
                            <div class="glass-card p-4 border border-slate-100">
                                <div class="text-[11px] font-bold text-slate-600 mb-2">预览</div>
                                <div class="w-full h-56 border-l-2 border-b-2 border-slate-100 relative flex items-end justify-around pb-2 px-12">
                                    <div class="w-14 bg-blue-600/90 rounded-t-xl h-[45%] shadow-lg"></div>
                                    <div class="w-14 bg-blue-600/90 rounded-t-xl h-[70%] shadow-lg"></div>
                                    <div class="w-14 bg-blue-600/90 rounded-t-xl h-[90%] shadow-lg"></div>
                                    <div class="w-14 bg-rose-500 rounded-t-xl h-[30%] border-b-4 border-rose-700 animate-pulse"></div>
                                </div>
                            </div>
                            <div class="text-[10px] text-slate-400 italic">从右侧选择数据源与预制分析工具，一键生成结果。</div>
                        </div>
                    </div>
                    <div id="view-data"
                        class="tab-view hidden h-full flex items-center justify-center text-slate-300 italic">
                        加载百万级数据网格...</div>
                    <div id="view-sql" class="tab-view hidden h-full p-6 font-mono text-xs text-blue-600 bg-slate-50">
                        SELECT woe(inc) FROM loan_data...</div>
                    <div id="view-model" class="tab-view hidden h-full flex items-center justify-center text-green-500">
                        模型就绪: v1.0.2</div>
                </div>
            </section>

            <section id="side-bottom" class="sidebar-anim h-48 flex-none flex flex-col">
                <div class="glass-card flex-1 flex flex-col overflow-hidden border-blue-50">
                    <div class="h-8 px-4 border-b border-slate-100 flex items-center justify-between bg-slate-50/50">
                        <span class="text-[10px] font-black text-slate-400 uppercase italic">Copilot Dashboard</span>
                        <button onclick="toggle('bottom')" class="text-slate-300 hover:text-slate-600"><i
                                class="fas fa-chevron-down"></i></button>
                    </div>
                    <div id="copilot-feed" class="flex-1 p-4 overflow-y-auto space-y-4">
                        <div class="flex space-x-3 items-start">
                            <div
                                class="w-7 h-7 bg-blue-600 rounded-lg flex items-center justify-center text-white text-[10px] shadow-lg">
                                AI</div>
                            <div
                                class="flex-1 bg-blue-50/50 p-3 rounded-2xl rounded-tl-none border border-blue-100 text-sm text-slate-600 leading-relaxed shadow-sm">
                                <b>loan_data_v2</b> 已挂载。检测到 <b>annual_inc</b> 在高收入区间坏账率突然跳升。是否执行 <b>/auto_fix_bins</b>？
                            </div>
                        </div>
                    </div>
                    <div class="p-3 pt-0">
                        <div class="command-bar-highlight rounded-2xl flex items-center p-1.5 px-3">
                            <div class="text-blue-600 font-bold text-xs pr-3 border-r border-slate-100">PROMPT</div>
                            <input type="text" placeholder="输入建模指令，例如：'重新计算分箱'..."
                                class="flex-1 bg-transparent border-none outline-none px-4 text-sm text-slate-700 placeholder:text-slate-300">
                            <button
                                class="bg-blue-600 hover:bg-blue-700 text-white w-9 h-9 rounded-xl flex items-center justify-center shadow-lg shadow-blue-200">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <aside id="side-right" class="sidebar-anim w-64 flex-none flex flex-col gap-4">
            <div class="glass-card flex-1 flex flex-col overflow-hidden">
                <div class="p-3 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                    <button onclick="toggle('right')" class="text-slate-300 hover:text-blue-600"><i
                            class="fas fa-outdent"></i></button>
                    <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Risk Toolkit</span>
                </div>

                <div class="flex-1 overflow-y-auto p-2 space-y-4">
                    <div class="p-3 bg-white border border-slate-100 rounded-xl">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Data Source</span>
                            <span id="ds-badge" class="text-[9px] font-bold px-2 py-0.5 bg-blue-50 text-blue-700 rounded-full">loan_data_v2</span>
                        </div>
                        <select id="ds-select" class="w-full text-xs border border-slate-200 rounded-lg px-2 py-2 bg-white">
                            <option value="loan_data_v2">loan_data_v2 (Hive Production)</option>
                            <option value="sql_result_202501">sql_result_202501 (Ad-hoc Query)</option>
                            <option value="feature_store_v1">feature_store_v1 (Derived Dataset)</option>
                        </select>
                        <div class="grid grid-cols-2 gap-2 mt-2">
                            <div>
                                <div class="text-[9px] text-slate-400 font-bold mb-1">特征列</div>
                                <select id="feature-select" class="w-full text-xs border border-slate-200 rounded-lg px-2 py-2 bg-white"></select>
                            </div>
                            <div>
                                <div class="text-[9px] text-slate-400 font-bold mb-1">标签列</div>
                                <select id="label-select" class="w-full text-xs border border-slate-200 rounded-lg px-2 py-2 bg-white"></select>
                            </div>
                        </div>
                    </div>
                    <div>
                        <div onclick="toggleAccordion('acc-op1', 'arr-op1')"
                            class="flex items-center text-[10px] font-bold text-slate-400 p-2 cursor-pointer hover:text-slate-600 uppercase">
                            <i id="arr-op1" class="fas fa-chevron-right mr-2 rotate-icon"></i> 01 Data Probe
                        </div>
                        <div id="acc-op1" class="accordion-content px-2 grid grid-cols-2 gap-2 mt-1">
                            <div
                                onclick="runPreset('missing')"
                                class="p-2 border border-slate-100 rounded bg-slate-50 text-center hover:border-blue-300 cursor-pointer">
                                <i class="fas fa-search text-blue-500 mb-1 block"></i><span
                                    class="text-[9px] font-bold">缺失分析</span>
                            </div>
                            <div
                                onclick="runPreset('outlier')"
                                class="p-2 border border-slate-100 rounded bg-slate-50 text-center hover:border-blue-300 cursor-pointer">
                                <i class="fas fa-warning text-red-500 mb-1 block"></i><span
                                    class="text-[9px] font-bold">异常检测</span>
                            </div>
                            <div onclick="runPreset('duplicates')"
                                class="p-2 border border-slate-100 rounded bg-slate-50 text-center hover:border-blue-300 cursor-pointer">
                                <i class="fas fa-clone text-slate-500 mb-1 block"></i><span class="text-[9px] font-bold">重复值</span>
                            </div>
                            <div onclick="runPreset('distribution')"
                                class="p-2 border border-slate-100 rounded bg-slate-50 text-center hover:border-blue-300 cursor-pointer">
                                <i class="fas fa-chart-line text-indigo-500 mb-1 block"></i><span class="text-[9px] font-bold">分布概览</span>
                            </div>
                        </div>
                    </div>

                    <div>
                        <div onclick="toggleAccordion('acc-op2', 'arr-op2')"
                            class="flex items-center text-[10px] font-bold text-blue-600 p-2 cursor-pointer uppercase">
                            <i id="arr-op2" class="fas fa-chevron-right mr-2 rotate-icon"></i> 02 Feature Eng
                        </div>
                        <div id="acc-op2" class="accordion-content open px-2 space-y-2 mt-1">
                            <div
                                onclick="runPreset('woe')"
                                class="p-3 bg-white border-2 border-blue-100 rounded-xl shadow-sm flex items-center hover:shadow-md cursor-pointer transition-all">
                                <div
                                    class="w-8 h-8 bg-blue-600 rounded flex items-center justify-center text-white mr-3">
                                    <i class="fas fa-chart-bar"></i></div>
                                <div>
                                    <p class="text-[11px] font-bold">WOE 分箱</p>
                                    <p class="text-[8px] text-slate-400">IV & 单调性调节</p>
                                </div>
                            </div>
                            <div
                                onclick="runPreset('pca')"
                                class="p-3 bg-white border border-slate-100 rounded-xl shadow-sm flex items-center hover:shadow-md cursor-pointer transition-all">
                                <div
                                    class="w-8 h-8 bg-purple-100 text-purple-600 rounded flex items-center justify-center mr-3">
                                    <i class="fas fa-compress-arrows-alt"></i></div>
                                <span class="text-[11px] font-bold text-slate-500">PCA 降维</span>
                            </div>
                            <div onclick="runPreset('correlation')"
                                class="p-3 bg-white border border-slate-100 rounded-xl shadow-sm flex items-center hover:shadow-md cursor-pointer transition-all">
                                <div class="w-8 h-8 bg-amber-100 text-amber-700 rounded flex items-center justify-center mr-3">
                                    <i class="fas fa-link"></i>
                                </div>
                                <span class="text-[11px] font-bold text-slate-500">相关性矩阵</span>
                            </div>
                        </div>
                    </div>

                    <div>
                        <div onclick="toggleAccordion('acc-op3', 'arr-op3')"
                            class="flex items-center text-[10px] font-bold text-slate-400 p-2 cursor-pointer uppercase">
                            <i id="arr-op3" class="fas fa-chevron-right mr-2 rotate-icon"></i> 03 Evaluation
                        </div>
                        <div id="acc-op3" class="accordion-content px-2 space-y-2 mt-1">
                            <div onclick="runPreset('ksroc')"
                                class="p-2.5 bg-white border border-slate-100 rounded-xl flex items-center hover:shadow-md cursor-pointer transition-all">
                                <div
                                    class="w-8 h-8 bg-green-500 rounded flex items-center justify-center text-white mr-3">
                                    <i class="fas fa-rocket"></i></div>
                                <span class="text-[11px] font-bold">KS / ROC 曲线</span>
                            </div>
                            <div onclick="runPreset('psi')"
                                class="p-2.5 bg-white border border-slate-100 rounded-xl flex items-center hover:shadow-md cursor-pointer transition-all">
                                <div class="w-8 h-8 bg-rose-100 text-rose-700 rounded flex items-center justify-center mr-3">
                                    <i class="fas fa-wave-square"></i>
                                </div>
                                <span class="text-[11px] font-bold">稳定性 PSI</span>
                            </div>
                        </div>
                    </div>

                    <div>
                        <div onclick="toggleAccordion('acc-op4', 'arr-op4')"
                            class="flex items-center text-[10px] font-bold text-slate-400 p-2 cursor-pointer uppercase">
                            <i id="arr-op4" class="fas fa-chevron-right mr-2 rotate-icon"></i> 04 EDA
                        </div>
                        <div id="acc-op4" class="accordion-content px-2 space-y-2 mt-1">
                            <div onclick="runPreset('stats')"
                                class="p-2.5 bg-white border border-slate-100 rounded-xl flex items-center hover:shadow-md cursor-pointer transition-all">
                                <div class="w-8 h-8 bg-slate-900 rounded flex items-center justify-center text-white mr-3">
                                    <i class="fas fa-square-poll-vertical"></i>
                                </div>
                                <span class="text-[11px] font-bold">描述统计</span>
                            </div>
                            <div onclick="runPreset('group_compare')"
                                class="p-2.5 bg-white border border-slate-100 rounded-xl flex items-center hover:shadow-md cursor-pointer transition-all">
                                <div class="w-8 h-8 bg-cyan-100 text-cyan-700 rounded flex items-center justify-center mr-3">
                                    <i class="fas fa-layer-group"></i>
                                </div>
                                <span class="text-[11px] font-bold">分组对比</span>
                            </div>
                            <div onclick="runPreset('trend')"
                                class="p-2.5 bg-white border border-slate-100 rounded-xl flex items-center hover:shadow-md cursor-pointer transition-all">
                                <div class="w-8 h-8 bg-indigo-100 text-indigo-700 rounded flex items-center justify-center mr-3">
                                    <i class="fas fa-chart-area"></i>
                                </div>
                                <span class="text-[11px] font-bold">趋势分析</span>
                            </div>
                        </div>
                    </div>

                    <div class="px-2">
                        <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2">Artifacts</div>
                        <div id="artifact-list" class="space-y-2"></div>
                    </div>
                </div>
                <div class="p-3 border-t border-slate-100 bg-slate-50/30">
                    <button onclick="runPreset('report')"
                        class="w-full bg-slate-900 text-white py-2.5 rounded-xl text-[10px] font-bold shadow-lg hover:bg-black transition-all">
                        <i class="fas fa-file-export mr-2"></i> 生成风控分析报告
                    </button>
                </div>
            </div>
        </aside>
    </div>

    <script>
        const appState = {
            datasets: {
                loan_data_v2: {
                    label: 'Hive Production',
                    columns: [
                        { name: 'user_id', type: 'id' },
                        { name: 'annual_inc', type: 'number' },
                        { name: 'loan_amnt', type: 'number' },
                        { name: 'dti', type: 'number' },
                        { name: 'grade', type: 'category' },
                        { name: 'issue_date', type: 'time' },
                        { name: 'bad_flag', type: 'label' }
                    ]
                },
                sql_result_202501: {
                    label: 'Ad-hoc Query',
                    columns: [
                        { name: 'customer_id', type: 'id' },
                        { name: 'mob', type: 'number' },
                        { name: 'dpd_30d', type: 'number' },
                        { name: 'snapshot_dt', type: 'time' },
                        { name: 'bad_flag', type: 'label' }
                    ]
                },
                feature_store_v1: {
                    label: 'Derived Dataset',
                    columns: [
                        { name: 'entity_id', type: 'id' },
                        { name: 'woe_annual_inc', type: 'number' },
                        { name: 'woe_dti', type: 'number' },
                        { name: 'pscore_v1', type: 'number' },
                        { name: 'snapshot_dt', type: 'time' },
                        { name: 'bad_flag', type: 'label' }
                    ]
                }
            },
            selectedDatasetId: 'loan_data_v2',
            selectedFeature: 'annual_inc',
            selectedLabel: 'bad_flag',
            artifacts: []
        };

        const tools = {
            missing: {
                name: '缺失分析',
                run: ({ datasetId }) => ({
                    title: `缺失分析: ${datasetId}`,
                    badges: [
                        { text: '字段 7', tone: 'slate' },
                        { text: '高缺失 1', tone: 'rose' }
                    ],
                    html: `
                        <div class="glass-card p-4 border border-slate-100">
                            <div class="flex items-center justify-between">
                                <div class="text-[11px] font-bold text-slate-600">缺失概览</div>
                                <div class="text-[10px] text-slate-400">按缺失率排序</div>
                            </div>
                            <div class="mt-3 space-y-2 text-xs">
                                ${renderBarRow('annual_inc', 0.15, 'bg-amber-500')}
                                ${renderBarRow('dti', 0.04, 'bg-blue-600')}
                                ${renderBarRow('grade', 0.01, 'bg-blue-600')}
                                ${renderBarRow('bad_flag', 0.00, 'bg-slate-300')}
                            </div>
                        </div>
                    `
                })
            },
            outlier: {
                name: '异常检测',
                run: ({ datasetId, feature }) => ({
                    title: `异常检测: ${feature}`,
                    badges: [
                        { text: 'IQR', tone: 'slate' },
                        { text: '异常 0.7%', tone: 'rose' }
                    ],
                    html: `
                        <div class="glass-card p-4 border border-slate-100">
                            <div class="text-[11px] font-bold text-slate-600 mb-2">异常样本摘要</div>
                            <div class="grid grid-cols-3 gap-3">
                                ${renderKpi('P50', '62,000')}
                                ${renderKpi('P95', '180,000')}
                                ${renderKpi('P99', '420,000')}
                            </div>
                            <div class="mt-4 text-xs text-slate-500">检测到高收入尾部聚集，建议分箱时增加尾部单独成箱。</div>
                        </div>
                    `
                })
            },
            duplicates: {
                name: '重复值',
                run: ({ datasetId }) => ({
                    title: `重复值检查: ${datasetId}`,
                    badges: [
                        { text: '主键疑似', tone: 'slate' },
                        { text: '重复 0.02%', tone: 'amber' }
                    ],
                    html: `
                        <div class="glass-card p-4 border border-slate-100">
                            <div class="text-[11px] font-bold text-slate-600 mb-2">重复记录</div>
                            <div class="text-xs text-slate-500">建议以 user_id + issue_date 作为复合键做二次校验。</div>
                            <div class="mt-3 grid grid-cols-2 gap-3">
                                ${renderKpi('重复行数', '214')}
                                ${renderKpi('重复比例', '0.02%')}
                            </div>
                        </div>
                    `
                })
            },
            distribution: {
                name: '分布概览',
                run: ({ datasetId, feature }) => ({
                    title: `分布概览: ${feature}`,
                    badges: [
                        { text: '数值列', tone: 'slate' },
                        { text: '偏态', tone: 'amber' }
                    ],
                    html: `
                        <div class="glass-card p-4 border border-slate-100">
                            <div class="flex items-center justify-between">
                                <div class="text-[11px] font-bold text-slate-600">直方图（示意）</div>
                                <div class="text-[10px] text-slate-400">抽样 50k</div>
                            </div>
                            <div class="mt-3 w-full h-44 border border-slate-100 rounded-lg bg-slate-50 flex items-end justify-between px-3 pb-3 gap-2">
                                ${renderBars([12, 22, 35, 60, 80, 45, 28, 16, 10], 'bg-blue-600')}
                            </div>
                        </div>
                    `
                })
            },
            correlation: {
                name: '相关性矩阵',
                run: ({ datasetId }) => ({
                    title: `相关性矩阵: ${datasetId}`,
                    badges: [
                        { text: '数值列 4', tone: 'slate' },
                        { text: '高相关 1', tone: 'amber' }
                    ],
                    html: `
                        <div class="glass-card p-4 border border-slate-100">
                            <div class="text-[11px] font-bold text-slate-600 mb-3">相关性热力（示意）</div>
                            <div class="grid grid-cols-4 gap-2 text-[10px]">
                                ${renderHeatRow('annual_inc', [1.00, 0.12, 0.08, -0.21])}
                                ${renderHeatRow('loan_amnt', [0.12, 1.00, 0.62, 0.15])}
                                ${renderHeatRow('dti', [0.08, 0.62, 1.00, 0.33])}
                                ${renderHeatRow('mob', [-0.21, 0.15, 0.33, 1.00])}
                            </div>
                            <div class="mt-3 text-xs text-slate-500">提示：loan_amnt 与 dti 相关性较高，建议评估共线性影响。</div>
                        </div>
                    `
                })
            },
            woe: {
                name: 'WOE 分箱',
                run: ({ datasetId, feature, label }) => ({
                    title: `WOE 分箱: ${feature} -> ${label}`,
                    badges: [
                        { text: 'IV 0.31', tone: 'blue' },
                        { text: '单调性异常', tone: 'rose' }
                    ],
                    html: `
                        <div class="glass-card p-4 border border-slate-100">
                            <div class="flex items-center justify-between mb-3">
                                <div class="text-[11px] font-bold text-slate-600">分箱结果（示意）</div>
                                <div class="text-[10px] text-slate-400">5 bins</div>
                            </div>
                            <div class="grid grid-cols-5 gap-2 h-40 items-end">
                                ${renderBinBar('Bin1', 0.10, 'bg-blue-600')}
                                ${renderBinBar('Bin2', 0.14, 'bg-blue-600')}
                                ${renderBinBar('Bin3', 0.18, 'bg-blue-600')}
                                ${renderBinBar('Bin4', 0.22, 'bg-blue-600')}
                                ${renderBinBar('Bin5', 0.35, 'bg-rose-500')}
                            </div>
                            <div class="mt-3 text-xs text-slate-500">建议：合并尾部箱或启用单调性约束重分箱。</div>
                        </div>
                    `
                })
            },
            pca: {
                name: 'PCA 降维',
                run: ({ datasetId }) => ({
                    title: `PCA 降维: ${datasetId}`,
                    badges: [
                        { text: '主成分 3', tone: 'slate' },
                        { text: '解释率 86%', tone: 'blue' }
                    ],
                    html: `
                        <div class="glass-card p-4 border border-slate-100">
                            <div class="text-[11px] font-bold text-slate-600 mb-2">解释方差（示意）</div>
                            <div class="grid grid-cols-3 gap-3">
                                ${renderKpi('PC1', '52%')}
                                ${renderKpi('PC2', '21%')}
                                ${renderKpi('PC3', '13%')}
                            </div>
                            <div class="mt-3 text-xs text-slate-500">输出：降维后的特征集（Derived Dataset）。</div>
                        </div>
                    `
                })
            },
            ksroc: {
                name: 'KS / ROC 曲线',
                run: ({ datasetId }) => ({
                    title: `模型评估: KS / ROC (${datasetId})`,
                    badges: [
                        { text: 'AUC 0.78', tone: 'blue' },
                        { text: 'KS 0.42', tone: 'green' }
                    ],
                    html: `
                        <div class="glass-card p-4 border border-slate-100">
                            <div class="text-[11px] font-bold text-slate-600 mb-2">评估摘要</div>
                            <div class="grid grid-cols-3 gap-3">
                                ${renderKpi('AUC', '0.78')}
                                ${renderKpi('KS', '0.42')}
                                ${renderKpi('最佳阈值', '0.31')}
                            </div>
                            <div class="mt-4 text-xs text-slate-500">输出：评估图表（Chart）与阈值表（Table）。</div>
                        </div>
                    `
                })
            },
            psi: {
                name: '稳定性 PSI',
                run: ({ datasetId, feature }) => ({
                    title: `稳定性 PSI: ${feature}`,
                    badges: [
                        { text: 'PSI 0.19', tone: 'amber' },
                        { text: '轻度漂移', tone: 'amber' }
                    ],
                    html: `
                        <div class="glass-card p-4 border border-slate-100">
                            <div class="flex items-center justify-between">
                                <div class="text-[11px] font-bold text-slate-600">分箱 PSI（示意）</div>
                                <div class="text-[10px] text-slate-400">Base vs Current</div>
                            </div>
                            <div class="mt-3 space-y-2 text-xs">
                                ${renderBarRow('Bin1', 0.02, 'bg-green-500')}
                                ${renderBarRow('Bin2', 0.04, 'bg-green-500')}
                                ${renderBarRow('Bin3', 0.05, 'bg-amber-500')}
                                ${renderBarRow('Bin4', 0.03, 'bg-green-500')}
                                ${renderBarRow('Bin5', 0.05, 'bg-amber-500')}
                            </div>
                        </div>
                    `
                })
            },
            stats: {
                name: '描述统计',
                run: ({ datasetId }) => ({
                    title: `描述统计: ${datasetId}`,
                    badges: [
                        { text: '摘要', tone: 'slate' },
                        { text: '可导出', tone: 'blue' }
                    ],
                    html: `
                        <div class="glass-card p-4 border border-slate-100">
                            <div class="text-[11px] font-bold text-slate-600 mb-3">数值列摘要（示意）</div>
                            <div class="overflow-hidden border border-slate-100 rounded-xl">
                                <div class="grid grid-cols-5 bg-slate-50 text-[10px] font-bold text-slate-500 px-3 py-2">
                                    <div>列</div><div class="text-right">P50</div><div class="text-right">P95</div><div class="text-right">均值</div><div class="text-right">Std</div>
                                </div>
                                ${renderStatRow('annual_inc', '62k', '180k', '71k', '28k')}
                                ${renderStatRow('loan_amnt', '9k', '24k', '11k', '6k')}
                                ${renderStatRow('dti', '14.2', '31.0', '15.6', '6.8')}
                            </div>
                        </div>
                    `
                })
            },
            group_compare: {
                name: '分组对比',
                run: ({ datasetId }) => ({
                    title: `分组对比: grade`,
                    badges: [
                        { text: '类别列', tone: 'slate' },
                        { text: '差异显著', tone: 'amber' }
                    ],
                    html: `
                        <div class="glass-card p-4 border border-slate-100">
                            <div class="flex items-center justify-between">
                                <div class="text-[11px] font-bold text-slate-600">坏账率按 grade 分组（示意）</div>
                                <div class="text-[10px] text-slate-400">label: bad_flag</div>
                            </div>
                            <div class="mt-3 grid grid-cols-6 gap-2 h-40 items-end">
                                ${renderBinBar('A', 0.06, 'bg-blue-600')}
                                ${renderBinBar('B', 0.09, 'bg-blue-600')}
                                ${renderBinBar('C', 0.12, 'bg-blue-600')}
                                ${renderBinBar('D', 0.16, 'bg-amber-500')}
                                ${renderBinBar('E', 0.21, 'bg-amber-500')}
                                ${renderBinBar('F', 0.28, 'bg-rose-500')}
                            </div>
                        </div>
                    `
                })
            },
            trend: {
                name: '趋势分析',
                run: ({ datasetId }) => ({
                    title: `趋势分析: snapshot_dt`,
                    badges: [
                        { text: '时间列', tone: 'slate' },
                        { text: '波动', tone: 'amber' }
                    ],
                    html: `
                        <div class="glass-card p-4 border border-slate-100">
                            <div class="flex items-center justify-between">
                                <div class="text-[11px] font-bold text-slate-600">坏账率趋势（示意）</div>
                                <div class="text-[10px] text-slate-400">最近 6 期</div>
                            </div>
                            <div class="mt-3 w-full h-44 border border-slate-100 rounded-lg bg-slate-50 flex items-end justify-between px-3 pb-3 gap-2">
                                ${renderBars([10, 14, 18, 16, 22, 25], 'bg-indigo-600')}
                            </div>
                        </div>
                    `
                })
            },
            report: {
                name: '生成风控分析报告',
                run: ({ datasetId }) => ({
                    title: `风控分析报告（草稿）: ${datasetId}`,
                    badges: [
                        { text: '自动汇总', tone: 'slate' },
                        { text: `引用产物 ${Math.min(appState.artifacts.length, 5)}`, tone: 'blue' }
                    ],
                    html: `
                        <div class="glass-card p-4 border border-slate-100">
                            <div class="text-[11px] font-bold text-slate-600 mb-2">报告草稿（示意）</div>
                            <div class="text-xs text-slate-600 leading-relaxed">
                                <div class="font-bold mb-1">1. 关键结论</div>
                                <div class="mb-2">本期样本在部分特征存在稳定性波动与尾部异常，建议进行分箱与阈值复核。</div>
                                <div class="font-bold mb-1">2. 证据引用</div>
                                <ul class="list-disc pl-5 space-y-1">
                                    ${appState.artifacts.slice(0, 5).map(a => `<li>${escapeHtml(a.title)}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                    `
                })
            }
        };

        function toggle(side) {
            const el = document.getElementById('side-' + side);
            const handle = document.getElementById('h-' + side);
            const classList = {
                left: 'is-collapsed-left',
                right: 'is-collapsed-right',
                bottom: 'is-collapsed-bottom'
            };
            el.classList.toggle(classList[side]);
            handle.style.display = el.classList.contains(classList[side]) ? 'flex' : 'none';
        }

        function toggleAccordion(contentId, arrowId) {
            document.getElementById(contentId).classList.toggle('open');
            document.getElementById(arrowId).classList.toggle('open');
        }

        function switchTab(tabId) {
            document.querySelectorAll('.micro-tab').forEach(b => b.classList.remove('active'));
            document.getElementById('tab-' + tabId).classList.add('active');

            document.querySelectorAll('.tab-view').forEach(v => v.classList.add('hidden'));
            document.getElementById('view-' + tabId).classList.remove('hidden');
        }

        function resetAll() {
            ['left', 'right', 'bottom'].forEach(side => {
                const el = document.getElementById('side-' + side);
                const handle = document.getElementById('h-' + side);
                el.classList.remove('is-collapsed-left', 'is-collapsed-right', 'is-collapsed-bottom');
                handle.style.display = 'none';
            });
        }

        function runPreset(toolId) {
            const tool = tools[toolId];
            if (!tool) return;

            const result = tool.run({
                datasetId: appState.selectedDatasetId,
                feature: appState.selectedFeature,
                label: appState.selectedLabel
            });

            const artifact = {
                id: `a_${Date.now()}_${Math.floor(Math.random() * 1000)}`,
                toolId,
                title: result.title,
                datasetId: appState.selectedDatasetId,
                createdAt: new Date().toISOString(),
                badges: result.badges || [],
                html: result.html
            };

            appState.artifacts.unshift(artifact);
            if (appState.artifacts.length > 30) appState.artifacts.length = 30;

            renderArtifactList();
            renderHistory();
            renderOutput(artifact);
            appendCopilotMessage(`已执行：${tool.name}（数据源：${appState.selectedDatasetId}）`);
            switchTab('visual');
        }

        function renderOutput(artifact) {
            const titleEl = document.getElementById('analysis-title');
            const badgesEl = document.getElementById('analysis-badges');
            const outputEl = document.getElementById('analysis-output');
            if (!titleEl || !badgesEl || !outputEl) return;

            titleEl.innerHTML = `<span class="w-2 h-2 bg-blue-500 rounded-full mr-2"></span> ${escapeHtml(artifact.title)}`;
            badgesEl.innerHTML = (artifact.badges || []).map(b => renderBadge(b)).join('');
            outputEl.innerHTML = artifact.html;
        }

        function renderArtifactList() {
            const listEl = document.getElementById('artifact-list');
            if (!listEl) return;
            listEl.innerHTML = appState.artifacts.slice(0, 6).map(a => `
                <div onclick="openArtifact('${a.id}')" class="p-2 bg-white border border-slate-100 rounded-lg hover:border-blue-200 cursor-pointer">
                    <div class="text-[10px] font-bold text-slate-600 truncate">${escapeHtml(a.title)}</div>
                    <div class="text-[9px] text-slate-400 mt-0.5">Source: ${escapeHtml(a.datasetId)}</div>
                </div>
            `).join('');
        }

        function openArtifact(artifactId) {
            const artifact = appState.artifacts.find(a => a.id === artifactId);
            if (!artifact) return;
            renderOutput(artifact);
            appendCopilotMessage(`已打开产物：${artifact.title}`);
            switchTab('visual');
        }

        function renderHistory() {
            const histEl = document.getElementById('acc-hist');
            if (!histEl) return;
            const top = appState.artifacts.slice(0, 5);
            if (top.length === 0) {
                histEl.innerHTML = `<div class="px-3 text-[10px] text-slate-400 italic py-1">暂无运行记录</div>`;
                return;
            }
            histEl.innerHTML = top.map(a => `
                <div onclick="openArtifact('${a.id}')" class="px-2 py-1.5 rounded hover:bg-slate-50 cursor-pointer">
                    <div class="text-[10px] font-bold text-slate-600 truncate">${escapeHtml(a.title)}</div>
                    <div class="text-[9px] text-slate-400 truncate">${escapeHtml(a.datasetId)}</div>
                </div>
            `).join('');
        }

        function appendCopilotMessage(text) {
            const feed = document.getElementById('copilot-feed');
            if (!feed) return;
            const item = document.createElement('div');
            item.className = 'flex space-x-3 items-start';
            item.innerHTML = `
                <div class="w-7 h-7 bg-blue-600 rounded-lg flex items-center justify-center text-white text-[10px] shadow-lg">AI</div>
                <div class="flex-1 bg-blue-50/50 p-3 rounded-2xl rounded-tl-none border border-blue-100 text-sm text-slate-600 leading-relaxed shadow-sm">
                    ${escapeHtml(text)}
                </div>
            `;
            feed.prepend(item);
        }

        function initSelectors() {
            const dsSelect = document.getElementById('ds-select');
            const dsBadge = document.getElementById('ds-badge');
            const featureSelect = document.getElementById('feature-select');
            const labelSelect = document.getElementById('label-select');
            if (!dsSelect || !dsBadge || !featureSelect || !labelSelect) return;

            dsSelect.value = appState.selectedDatasetId;
            dsSelect.addEventListener('change', () => {
                setDataset(dsSelect.value);
            });

            featureSelect.addEventListener('change', () => {
                appState.selectedFeature = featureSelect.value;
            });
            labelSelect.addEventListener('change', () => {
                appState.selectedLabel = labelSelect.value;
            });

            setDataset(appState.selectedDatasetId);
        }

        function setDataset(datasetId) {
            const dataset = appState.datasets[datasetId];
            if (!dataset) return;
            appState.selectedDatasetId = datasetId;

            const dsBadge = document.getElementById('ds-badge');
            const dsSelect = document.getElementById('ds-select');
            const featureSelect = document.getElementById('feature-select');
            const labelSelect = document.getElementById('label-select');
            if (!dsBadge || !dsSelect || !featureSelect || !labelSelect) return;

            dsBadge.textContent = datasetId;
            dsSelect.value = datasetId;

            const featureCandidates = dataset.columns.filter(c => c.type === 'number').map(c => c.name);
            const labelCandidates = dataset.columns.filter(c => c.type === 'label').map(c => c.name);
            featureSelect.innerHTML = featureCandidates.map(c => `<option value="${escapeAttr(c)}">${escapeHtml(c)}</option>`).join('');
            labelSelect.innerHTML = labelCandidates.map(c => `<option value="${escapeAttr(c)}">${escapeHtml(c)}</option>`).join('');

            appState.selectedFeature = featureCandidates.includes(appState.selectedFeature) ? appState.selectedFeature : (featureCandidates[0] || '');
            appState.selectedLabel = labelCandidates.includes(appState.selectedLabel) ? appState.selectedLabel : (labelCandidates[0] || '');

            featureSelect.value = appState.selectedFeature;
            labelSelect.value = appState.selectedLabel;
        }

        function renderBadge(badge) {
            const tone = badge.tone || 'slate';
            const cls = {
                slate: 'bg-slate-100 text-slate-600',
                blue: 'bg-blue-100 text-blue-700',
                green: 'bg-green-100 text-green-700',
                amber: 'bg-amber-100 text-amber-700',
                rose: 'bg-rose-100 text-rose-700'
            }[tone] || 'bg-slate-100 text-slate-600';
            return `<span class="text-[10px] font-bold px-2 py-0.5 rounded-full ${cls}">${escapeHtml(badge.text)}</span>`;
        }

        function renderKpi(label, value) {
            return `
                <div class="p-3 bg-slate-50 border border-slate-100 rounded-xl">
                    <div class="text-[9px] text-slate-400 font-bold uppercase">${escapeHtml(label)}</div>
                    <div class="text-lg font-black text-slate-700 mt-1">${escapeHtml(value)}</div>
                </div>
            `;
        }

        function renderBarRow(name, ratio, barClass) {
            const pct = Math.round(ratio * 1000) / 10;
            const width = Math.max(2, Math.min(100, pct));
            return `
                <div class="flex items-center gap-3">
                    <div class="w-24 text-slate-600 text-[11px] font-bold truncate">${escapeHtml(name)}</div>
                    <div class="flex-1 h-2.5 bg-slate-100 rounded-full overflow-hidden">
                        <div class="h-2.5 ${barClass} rounded-full" style="width:${width}%"></div>
                    </div>
                    <div class="w-12 text-right text-slate-400 text-[10px] font-bold">${pct}%</div>
                </div>
            `;
        }

        function renderBars(values, barClass) {
            const max = Math.max(...values, 1);
            return values.map(v => {
                const h = Math.round((v / max) * 100);
                return `<div class="flex-1 ${barClass} rounded-t-lg opacity-90" style="height:${h}%"></div>`;
            }).join('');
        }

        function renderBinBar(label, badRate, barClass) {
            const h = Math.round(Math.max(6, Math.min(100, badRate * 100)));
            const pct = Math.round(badRate * 1000) / 10;
            return `
                <div class="flex flex-col items-center justify-end gap-2">
                    <div class="w-full ${barClass} rounded-t-xl" style="height:${h}%"></div>
                    <div class="text-[9px] text-slate-500 font-bold">${escapeHtml(label)}</div>
                    <div class="text-[9px] text-slate-400">${pct}%</div>
                </div>
            `;
        }

        function renderHeatRow(name, values) {
            return `
                <div class="contents">
                    <div class="text-[10px] font-bold text-slate-500 py-2">${escapeHtml(name)}</div>
                    ${values.map(v => renderHeatCell(v)).join('')}
                </div>
            `;
        }

        function renderHeatCell(v) {
            const val = Math.round(v * 100) / 100;
            const abs = Math.min(1, Math.abs(v));
            const bg = v >= 0 ? `rgba(37,99,235,${0.12 + abs * 0.38})` : `rgba(244,63,94,${0.12 + abs * 0.38})`;
            return `<div class="py-2 px-2 rounded text-center font-bold text-slate-700" style="background:${bg}">${val.toFixed(2)}</div>`;
        }

        function escapeHtml(str) {
            return String(str)
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#039;');
        }

        function escapeAttr(str) {
            return String(str)
                .replaceAll('&', '&amp;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#039;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;');
        }

        function renderStatRow(name, p50, p95, mean, std) {
            return `
                <div class="grid grid-cols-5 text-[10px] text-slate-600 px-3 py-2 border-t border-slate-100">
                    <div class="font-bold">${escapeHtml(name)}</div>
                    <div class="text-right">${escapeHtml(p50)}</div>
                    <div class="text-right">${escapeHtml(p95)}</div>
                    <div class="text-right">${escapeHtml(mean)}</div>
                    <div class="text-right">${escapeHtml(std)}</div>
                </div>
            `;
        }

        document.addEventListener('DOMContentLoaded', () => {
            initSelectors();
            renderArtifactList();
            renderHistory();
        });
    </script>
</body>

</html>
